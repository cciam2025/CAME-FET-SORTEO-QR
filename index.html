<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Día del Padre - CAME</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
    .container { max-width: 500px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #2c3e50; font-size: 1.8em; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #555; }
    input[type="text"], input[type="tel"], input[type="hidden"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    input[type="text"]:focus, input[type="tel"]:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25); }
    button { background-color: #3498db; color: white; padding: 12px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; transition: background-color 0.2s; }
    button:hover { background-color: #2980b9; }
    .negocio-info { text-align: center; margin-bottom: 10px; font-size: 1.2em; font-weight: bold; color: #333; }
    .negocio-details { text-align: center; margin-bottom: 25px; font-size: 0.95em; color: #555; line-height: 1.5; }
    #mensaje { margin-top: 20px; text-align:center; font-weight: bold; padding: 10px; border-radius: 4px; }
    #mensaje.success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
    #mensaje.error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
    @media (max-width: 600px) { h1 { font-size: 1.5em; } body { padding: 10px; } .container { margin: 10px auto; padding: 15px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sorteo Día del Padre</h1>
    <div id="negocioDisplay" class="negocio-info"></div>
    <div id="negocioDetailsDisplay" class="negocio-details"></div>

    <form id="formularioSorteo">
      <div class="form-group">
        <label for="nombreInput">Nombre</label>
        <input type="text" id="nombreInput" name="nombre" placeholder="Ingresa tu nombre" required>
      </div>
      <div class="form-group">
        <label for="apellidoInput">Apellido</label>
        <input type="text" id="apellidoInput" name="apellido" placeholder="Ingresa tu apellido" required>
      </div>
      <div class="form-group">
        <label for="dniInput">DNI</label>
        <input type="text" id="dniInput" name="dni" placeholder="DNI (sin puntos ni espacios)" required pattern="\d{7,8}" title="DNI debe tener 7 u 8 números.">
      </div>
      <div class="form-group">
        <label for="telefonoInput">Teléfono Participante</label>
        <input type="tel" id="telefonoInput" name="telefono" placeholder="Ej: 1122334455" required pattern="[0-9]{8,15}" title="Ingresa un número de teléfono válido.">
      </div>
      <div class="form-group">
        <label for="direccionInput">Dirección</label>
        <input type="text" id="direccionInput" name="direccion" placeholder="Ingresa tu dirección" required>
      </div>
      <div class="form-group">
        <label for="ciudadInput">Ciudad Participante</label>
        <input type="text" id="ciudadInput" name="ciudad" placeholder="Ingresa tu ciudad" required>
      </div>

      <!-- Campos ocultos para los datos del negocio -->
      <input type="hidden" name="negocio" id="nombreNegocioHidden">          <!-- Name: "negocio" -->
      <input type="hidden" name="razonsocial" id="razonSocialNegocioHidden"> <!-- Name: "razonsocial" -->
      <input type="hidden" name="cuit" id="cuitNegocioHidden">                <!-- Name: "cuit" -->
      <input type="hidden" name="ciudad_negocio" id="ciudadNegocioHidden">    <!-- Name: "ciudad_negocio" -->
      <input type="hidden" name="telefono_negocio" id="telefonoNegocioHidden"> <!-- Name: "telefono_negocio" -->

      <button type="submit" id="submitButton">Participar</button>
    </form>
    <div id="mensaje"></div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxQyBF1rlrqE6P36_QWyCbAjsPZsLdullebFbP04AWsDi6xLgRgLd6fIgsoBVkufe7R4g/exec'; // TU URL DE SCRIPT

    const params = new URLSearchParams(window.location.search);

    // Nombres de parámetros EXACTOS que esperas desde el Generador de QR
    const nombreComercioParam = params.get('negocio');
    const razonSocialParam = params.get('razonsocial');
    const cuitParam = params.get('cuit');
    const ciudadNegocioParam = params.get('ciudad_negocio');
    const telefonoNegocioParam = params.get('telefono_negocio');

    // Referencias a los INPUTS HIDDEN
    const nombreNegocioHiddenInput = document.getElementById('nombreNegocioHidden');
    const razonSocialNegocioHiddenInput = document.getElementById('razonSocialNegocioHidden');
    const cuitNegocioHiddenInput = document.getElementById('cuitNegocioHidden');
    const ciudadNegocioHiddenInput = document.getElementById('ciudadNegocioHidden');
    const telefonoNegocioHiddenInput = document.getElementById('telefonoNegocioHidden');

    const negocioDisplayElement = document.getElementById('negocioDisplay');
    const negocioDetailsDisplayElement = document.getElementById('negocioDetailsDisplay');
    const formulario = document.getElementById('formularioSorteo');
    const submitButton = document.getElementById('submitButton');
    const mensajeDiv = document.getElementById('mensaje');

    let displayNegocioPrincipal = "Comercio no especificado";
    let displayDetailsTextArray = [];

    if (nombreComercioParam) {
      const nombreDecodificado = decodeURIComponent(nombreComercioParam);
      nombreNegocioHiddenInput.value = nombreDecodificado; // Asigna al hidden
      displayNegocioPrincipal = `Comercio: ${nombreDecodificado}`;
      document.title = `Formulario Día del Padre - ${nombreDecodificado}`;
    }
    negocioDisplayElement.textContent = displayNegocioPrincipal;

    if (razonSocialParam) {
      const rsDecodificada = decodeURIComponent(razonSocialParam);
      razonSocialNegocioHiddenInput.value = rsDecodificada; // Asigna al hidden
      displayDetailsTextArray.push(`Razón Social: ${rsDecodificada}`);
    }
    if (cuitParam) {
      const cuitDecodificado = decodeURIComponent(cuitParam);
      cuitNegocioHiddenInput.value = cuitDecodificado; // Asigna al hidden
      displayDetailsTextArray.push(`CUIT: ${cuitDecodificado}`);
    }
    if (ciudadNegocioParam) {
      const ciudadNDecodificada = decodeURIComponent(ciudadNegocioParam);
      ciudadNegocioHiddenInput.value = ciudadNDecodificada; // Asigna al hidden
      // Opcional: displayDetailsTextArray.push(`Ciudad Negocio: ${ciudadNDecodificada}`);
    }
    if (telefonoNegocioParam) {
      const telefonoNDecodificado = decodeURIComponent(telefonoNegocioParam);
      telefonoNegocioHiddenInput.value = telefonoNDecodificado; // Asigna al hidden
      displayDetailsTextArray.push(`Tel. Ref.: ${telefonoNDecodificado}`);
    }

    if (negocioDetailsDisplayElement && displayDetailsTextArray.length > 0) {
        negocioDetailsDisplayElement.innerHTML = displayDetailsTextArray.join('<br>');
    } else if (negocioDetailsDisplayElement) {
        negocioDetailsDisplayElement.style.display = 'none';
    }

    formulario.addEventListener('submit', function(e) {
      e.preventDefault();
      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';
      mensajeDiv.textContent = '';
      mensajeDiv.className = '';

      const formData = new FormData(this); // FormData recogerá los valores de los inputs hidden

      fetch(scriptURL, { method: 'POST', body: formData })
      .then(response => response.json())
      .then(data => {
        console.log('Respuesta del servidor:', data); // MUY ÚTIL PARA DEBUG
        if (data.result === "success") {
          mensajeDiv.textContent = data.message || "¡Gracias por participar! Formulario enviado correctamente.";
          mensajeDiv.className = 'success';
          formulario.reset();
          // Repoblar campos hidden tras el reset si es necesario (para re-envío sin recarga)
          if (nombreComercioParam) nombreNegocioHiddenInput.value = decodeURIComponent(nombreComercioParam);
          if (razonSocialParam) razonSocialNegocioHiddenInput.value = decodeURIComponent(razonSocialParam);
          if (cuitParam) cuitNegocioHiddenInput.value = decodeURIComponent(cuitParam);
          if (ciudadNegocioParam) ciudadNegocioHiddenInput.value = decodeURIComponent(ciudadNegocioParam);
          if (telefonoNegocioParam) telefonoNegocioHiddenInput.value = decodeURIComponent(telefonoNegocioParam);
        } else {
          mensajeDiv.textContent = "Error al enviar el formulario: " + (data.message || "Error desconocido.");
          mensajeDiv.className = 'error';
        }
      })
      .catch(error => {
        console.error('Error en fetch:', error);
        mensajeDiv.textContent = "Error de conexión al enviar el formulario. Intenta de nuevo.";
        mensajeDiv.className = 'error';
      })
      .finally(() => {
        submitButton.disabled = false;
        submitButton.textContent = 'Participar';
      });
    });
  </script>
</body>
</html>
